<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Jan 5, 2016 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=${outputEncoding}" />
    <title>CPD Results</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20160105" />
    <meta http-equiv="Content-Language" content="en" />
        
  </head>
  <body class="composite">
    <div id="banner">
                      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2016-01-05</span>
                  &nbsp;| <span id="projectVersion">Version: ${project.version}</span>
                      </div>
            <div class="xright">        
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>CPD Results<a name="CPD_Results"></a></h2><p>The following document contains the results of PMD's  <a class="externalLink" href="http://pmd.sourceforge.net/cpd.html">CPD</a> 4.3.</p></div><div class="section"><h2>Duplications<a name="Duplications"></a></h2><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPProducer.java</td><td>135</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPProducer.java</td><td>136</td></tr><tr class="b"><td colspan='2'><div><pre>                this.endpoint.setConfiguration(ftpConfiguration);
                Object overrule = exchange.getIn().getHeader(Exchange.OVERRULE_FILE_NAME);
                if (overrule != null) {
                    if (overrule instanceof Expression) {
                        value = overrule;
                    } else {
                        value = exchange.getContext().getTypeConverter().convertTo(String.class, exchange, overrule);
                    }
                } else {
                    value = exchange.getIn().getHeader(Exchange.FILE_NAME);
                }

                // if we have an overrule then override the existing header to use the overrule computed name
                // from this point forward
                if (overrule != null) {
                    exchange.getIn().setHeader(Exchange.FILE_NAME, value);
                }

                if (value != null &amp;&amp; value instanceof String &amp;&amp; StringHelper.hasStartToken((String) value, &quot;simple&quot;)) {
                    log.warn(&quot;Simple expression: {} detected in header: {} of type String. This feature has been &quot; +
                            &quot;removed (see CAMEL-6748).&quot;, value, Exchange.FILE_NAME);
                }

                // expression support
                Expression expression = endpoint.getFileName();
                if (value != null &amp;&amp; value instanceof Expression) {
                    expression = (Expression) value;
                }

                // evaluate the name as a String from the value
                String name;
                if (expression != null) {
                    log.trace(&quot;Filename evaluated as expression: {}&quot;, expression);
                    name = expression.evaluate(exchange, String.class);
                } else {
                    name = exchange.getContext().getTypeConverter().convertTo(String.class, exchange, value);
                }

                // flatten name
                if (name != null &amp;&amp; endpoint.isFlatten()) {
                    // check for both windows and unix separators
                    int pos = Math.max(name.lastIndexOf(&quot;/&quot;), name.lastIndexOf(&quot;\\&quot;));
                    if (pos != -1) {
                        name = name.substring(pos + 1);
                    }
                }

                // compute path by adding endpoint starting directory
                String endpointPath = endpoint.getConfiguration().getDirectory();
                String baseDir = &quot;&quot;;
                if (endpointPath.length() &gt; 0) {
                    // Its a directory so we should use it as a base path for the filename
                    // If the path isn't empty, we need to add a trailing / if it isn't already there
                    baseDir = endpointPath;
                    boolean trailingSlash = endpointPath.endsWith(&quot;/&quot;) || endpointPath.endsWith(&quot;\\&quot;);
                    if (!trailingSlash) {
                        baseDir += getFileSeparator();
                    }
                }
                if (name != null) {
                    answer = baseDir + name;
                } else {
                    // use a generated filename if no name provided
                    answer = baseDir + endpoint.getGeneratedFileName(exchange.getIn());
                }

                if (endpoint.getConfiguration().needToNormalize()) {
                    // must normalize path to cater for Windows and other OS
                    answer = normalizePath(answer);
                }

                return answer;
            } else {
                if(LOG.isWarnEnabled()) {
                    LOG.warn(&quot;A file was passed for a Communication Configuration:&quot;+cc.getRefName() +
                      &quot; but the connection is not active.  The file will be stored in directory:&quot;+
                       b2bmbDirectoryName);
                }

                String fileName = exchange.getIn().getHeader(Exchange.FILE_NAME, String.class);
                FileSystemEntry parentFileSystemEntry = null;
                try {
                    parentFileSystemEntry = getEndpoint().getFileSystemEntryDAO()
                            .getByRefName(b2bmbDirectoryName, dataDomain);
                } catch (B2BTransactionFailed e) {
                    throw new IllegalStateException(&quot;Could not get fileSystemEntry for path:&quot;+b2bmbDirectoryName,
                            e);
                }
                if (parentFileSystemEntry == null) {
                    throw new IllegalStateException(&quot;Directory does not exist. Domain: &quot; + dataDomain
                            + &quot; Path: &quot; + b2bmbDirectoryName);
                }

                InputStream message = exchange.getIn().getBody(InputStream.class);
                try {
                    getEndpoint().getFileSystemEntryDAO().createFileFromStream(exchange.getExchangeId(),
                            fileName,
                            parentFileSystemEntry.getId(), exchange.getIn().getBody(InputStream.class),
                            &quot;application/octet-stream&quot;, parentFileSystemEntry.getDataDomain(),
                            parentFileSystemEntry.getOwnerUserProfileRefName(),
                            exchange.getProperty(B2bmbCamelConstants.TRANSMISSION_ID, String.class));
                    return null;
                } catch (B2BNotFoundException e) {
                    throw new IllegalStateException(&quot;Could not save file path:&quot;+b2bmbDirectoryName,
                            e);
                } catch (B2BTransactionFailed e) {
                    throw new IllegalStateException(&quot;Could not save file path:&quot;+b2bmbDirectoryName, e);
                }
            }
        } else {
            throw new IllegalStateException(&quot;No Communication Configuration found for directory:&quot;+
                    b2bmbDirectoryName+ &quot; can not send file.&quot;);
        }
    }


    /**
     * @param exchange created exchange
     * @throws Exception thrown by camel
     */
    private void storeFile(Exchange exchange, String filePath, String dataDomain) throws Exception {
        FileSystemEntry parentFileSystemEntry = getEndpoint().getFileSystemEntryDAO()
                .getByRefName(filePath, dataDomain);
        if (parentFileSystemEntry == null) {
            throw new B2BNotFoundException(&quot;Directory does not exist. Domain: &quot; + dataDomain
                    + &quot; Path: &quot; + filePath);
        }

        //moved to success directory
        List&lt;FileSystemEntry&gt; fileSystemEntries = null;

        DynamicSearchRequest dynamicSearchRequest = new DynamicSearchRequest();
        DynamicAttribute parentAttribute = new DynamicAttribute();
        parentAttribute.setType(DynamicAttributeType.String);
        parentAttribute.setValue(parentFileSystemEntry.getId());
        parentAttribute.setRefName(&quot;parentFileEntryId&quot;);
        dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;parentFileEntryId&quot;, parentAttribute);

        DynamicAttribute directoryOnlyAttribute = new DynamicAttribute();
        directoryOnlyAttribute.setType(DynamicAttributeType.String);
        directoryOnlyAttribute.setValue(FileSystemEntryType.Directory.value());
        directoryOnlyAttribute.setRefName(&quot;type&quot;);
        dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;type&quot;, directoryOnlyAttribute);

        DynamicAttribute directoryNameAttribute = new DynamicAttribute();
        directoryNameAttribute.setType(DynamicAttributeType.String);
        directoryNameAttribute.setValue(&quot;.processed&quot;);

        directoryNameAttribute.setRefName(&quot;name&quot;);
        dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;name&quot;, directoryNameAttribute);

        List&lt;String&gt; dataDomains = new ArrayList&lt;String&gt;();
        dataDomains.add(parentFileSystemEntry.getDataDomain());

        fileSystemEntries = getEndpoint().getFileSystemEntryDAO().getList(
                dynamicSearchRequest, 0, 1, null, dataDomains);

        FileSystemEntry moveToDirectory = null;
        if (fileSystemEntries.isEmpty()) {
            //create directory since it doesn't exist
            FileSystemEntry newDirectory = new FileSystemEntry();
            newDirectory.setParentFileEntryId(parentFileSystemEntry.getId());
            newDirectory.setOwnerUserProfileRefName(parentFileSystemEntry.getOwnerUserProfileRefName());
            newDirectory.setName(&quot;.processed&quot;);
            newDirectory.setType(FileSystemEntryType.Directory);
            newDirectory.setDataDomain(parentFileSystemEntry.getDataDomain());
            moveToDirectory = getEndpoint().getFileSystemEntryDAO().save(newDirectory);
        } else {
            moveToDirectory = fileSystemEntries.get(0);
        }

        //default content type
        String contentType = &quot;application/octet-stream&quot;;
        if (exchange.getIn().getHeader(Exchange.CONTENT_TYPE, String.class) != null) {
            contentType = exchange.getIn().getHeader(Exchange.CONTENT_TYPE, String.class);
        }

        String fileName = exchange.getIn().getHeader(Exchange.FILE_NAME, String.class);
        if (fileName == null)
        {
            fileName = exchange.getIn().getHeader(&quot;DOWNLOADED_FILE&quot;, String.class);

        }

        if (fileName == null)
        {
            throw new IllegalStateException(&quot;File Name could not be resolved, need either:&quot; + Exchange.FILE_NAME +
                    &quot; or &quot; + &quot;DOWNLOADED_FILE in header&quot;);
        }


        InputStream in = exchange.getIn().getBody(InputStream.class);

        if ( in != null)
        {
            getEndpoint().getFileSystemEntryDAO().createFileFromStream(exchange.getExchangeId(),
                    fileName,
                    moveToDirectory.getId(), in,
                    contentType, parentFileSystemEntry.getDataDomain(),
                    parentFileSystemEntry.getOwnerUserProfileRefName(),
                    exchange.getProperty(B2bmbCamelConstants.TRANSMISSION_ID, String.class));
            if (LOG.isInfoEnabled()) {
                LOG.info(&quot;Endpoint URI at createFileSystemEntry method :: &quot; + getEndpoint().getEndpointUri());
            }
        }

    }

    private FtpConfiguration buildFtpConfiguration(CommunicationConfiguration cc) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbB2BProfileDirectoryConsumer.java</td><td>305</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemConsumer.java</td><td>197</td></tr><tr class="b"><td colspan='2'><div><pre>                                        B2bmbB2BProfileDirectoryEndpoint endpoint, Exchange exchange,
                                        boolean isSuccessful) {
        try {
            //moved to success directory
            List&lt;FileSystemEntry&gt; fileSystemEntries = null;

            DynamicSearchRequest dynamicSearchRequest = new DynamicSearchRequest();
            DynamicAttribute parentAttribute = new DynamicAttribute();
            parentAttribute.setType(DynamicAttributeType.String);
            parentAttribute.setValue(parentFileSystemEntry.getId());
            parentAttribute.setRefName(&quot;parentFileEntryId&quot;);
            dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;parentFileEntryId&quot;, parentAttribute);

            DynamicAttribute directoryOnlyAttribute = new DynamicAttribute();
            directoryOnlyAttribute.setType(DynamicAttributeType.String);
            directoryOnlyAttribute.setValue(FileSystemEntryType.Directory.value());
            directoryOnlyAttribute.setRefName(&quot;type&quot;);
            dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;type&quot;, directoryOnlyAttribute);

            DynamicAttribute directoryNameAttribute = new DynamicAttribute();
            directoryNameAttribute.setType(DynamicAttributeType.String);
            if (isSuccessful) {
                directoryNameAttribute.setValue(endpoint.getSuccessDirectory());
            } else {
                directoryNameAttribute.setValue(endpoint.getErrorDirectory());
            }
            directoryNameAttribute.setRefName(&quot;name&quot;);
            dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;name&quot;, directoryNameAttribute);

            List&lt;String&gt; dataDomains = new ArrayList&lt;String&gt;();
            dataDomains.add(parentFileSystemEntry.getDataDomain());

            fileSystemEntries = endpoint.getFileSystemEntryDAO().getList(dynamicSearchRequest, 0, 1, null, dataDomains);

            FileSystemEntry moveToDirectory = null;
            if (fileSystemEntries.isEmpty()) {
                //create directory since it doesn't exist
                FileSystemEntry newDirectory = new FileSystemEntry();
                newDirectory.setParentFileEntryId(parentFileSystemEntry.getId());
                newDirectory.setOwnerUserProfileRefName(parentFileSystemEntry.getOwnerUserProfileRefName());
                if (isSuccessful) {
                    newDirectory.setName(endpoint.getSuccessDirectory());
                } else {
                    newDirectory.setName(endpoint.getErrorDirectory());
                }
                newDirectory.setType(FileSystemEntryType.Directory);
                newDirectory.setDataDomain(parentFileSystemEntry.getDataDomain());
                moveToDirectory = endpoint.getFileSystemEntryDAO().save(newDirectory);
            } else {
                moveToDirectory = fileSystemEntries.get(0);
            }
            fileSystemEntry.setParentFileEntryId(moveToDirectory.getId());
            //update file name w/ timestamp to avoid duplicates
            String fileName = fileSystemEntry.getName();
            if (fileSystemEntry.getCreateDate() != null) {
                fileName = fileSystemEntry.getCreateDate().getTime() + &quot;_&quot; + fileName;
            } else {
                if (LOG.isDebugEnabled()) {
                    LOG.debug(String.format(&quot;Somehow fileSystemEntry with id %s domain %s refname %s &quot; +
                                    &quot;did not have a create date set&quot;, fileSystemEntry.getId(),
                            fileSystemEntry.getDataDomain(), fileSystemEntry.getRefName()));
                }
                fileName = Calendar.getInstance().getTime().getTime() + &quot;_&quot; + fileName;
            }
            fileSystemEntry.setName(fileName);
            endpoint.getFileSystemEntryDAO().save(fileSystemEntry);

        } catch (B2BTransactionFailed |B2BNotFoundException | ValidationException e) {

            if (LOG.isErrorEnabled()) {
                LOG.error(&quot;processRouteCompletion failed for fileSystemEntry &quot; + fileSystemEntry.getId() +
                        &quot;route was &quot; + (isSuccessful?&quot;successful&quot;:&quot;unsuccessful&quot;), e);
            }
        } finally {
            getEndpoint().getInProgressRepository().remove(fileSystemEntry.getId());
        }
    }
    @Override
    public int processBatch(Queue&lt;Object&gt; exchanges) {

        final int total = exchanges.size();

        for (int index = 0; index &lt; total &amp;&amp; isBatchAllowed(); index++) {
            // only loop if we are started (allowed to run)
            Exchange exchange = (Exchange) exchanges.poll();
            // add current index and total as properties
            exchange.setProperty(Exchange.BATCH_INDEX, index);
            exchange.setProperty(Exchange.BATCH_SIZE, total);
            exchange.setProperty(Exchange.BATCH_COMPLETE, index == total - 1);

            // update pending number of exchanges
            pendingExchanges = total - index - 1;
            String mailboxEntryId = exchange.getProperty(&quot;FileSystemEntryId&quot;).toString();

            if (LOG.isInfoEnabled()) {
                LOG.info(&quot;Sending FSE &quot; + index + &quot; of &quot; + total);
            }
            // process the current exchange
            try {
                getProcessor().process(exchange);
//CHECKSTYLE:OFF
            } catch (Exception e) {
                if (LOG.isErrorEnabled()) {
                    LOG.error(&quot;Exception occurred on processing exchange&quot;, e);
                }
                getEndpoint().getInProgressRepository().remove(mailboxEntryId);
            }
//CHECKSTYLE:ON
        }
        return total;
    }


    @Override
    public B2bmbB2BProfileDirectoryEndpoint getEndpoint() {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\interceptor\CamelTransmissionInterceptor.java</td><td>52</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\notifier\CamelConsumerTransmissionGenerator.java</td><td>56</td></tr><tr class="b"><td colspan='2'><div><pre>                try {
                    String transmissionId = exchange.getProperty(B2bmbCamelConstants.TRANSMISSION_ID, String.class);
                    Transmission transmission = null;
                    if (transmissionId != null) {
                        transmission = transmissionDAO.getById(transmissionId);
                    } else if(exchange.getIn().getHeader(B2bmbCamelConstants.TRANSMISSION_ID) != null) {
                        transmissionId = exchange.getIn().getHeader(B2bmbCamelConstants.TRANSMISSION_ID, String.class);
                        transmission = transmissionDAO.getById(transmissionId);
                    }
                    if (transmission == null) {
                        transmission = new Transmission();
                        //this would be very weird but maybe you preset the id in the route so supporting
                        if (transmissionId != null) {
                            transmission.setId(transmissionId);
                        }
                        transmission.setDataDomain(CamelDataDomainHelper.getDataDomainFromExchange(exchange));
                        transmission.setDirection(TransmissionDirection.INBOUND);
                        transmission.setStartDateTime(Calendar.getInstance().getTime());
                        if (exchange.getIn().getHeader(Exchange.FILE_NAME) != null) {
                            transmission.setFileNames(exchange.getIn().getHeader(Exchange.FILE_NAME, String.class));
                        }
                        transmission.setTransmissionObjectId(exchange.getExchangeId());
                        transmission.setTransmissionObjectIdType(&quot;Route Contents&quot;);
                        transmission.setStatus(TransmissionStatus.ROUTED);
                        transmission.setFromUser(&quot;Route:&quot; + exchange.getFromRouteId());
                        transmission = transmissionDAO.save(transmission);
                        transmissionId = transmission.getId();
                        exchange.setProperty(B2bmbCamelConstants.TRANSMISSION_ID, transmissionId);
                        exchange.getIn().setHeader(B2bmbCamelConstants.TRANSMISSION_ID, transmissionId);
                    }

                    if(transmission.getDataDomain() != null &amp;&amp;
                            !transmission.getDataDomain().equals(
                                    CamelDataDomainHelper.getDataDomainFromExchange(exchange))) {
                        transmission.getDataDomains().add(CamelDataDomainHelper.getDataDomainFromExchange(exchange));
                    } else if(transmission.getDataDomain() == null) {
                        transmission.getDataDomains().add(CamelDataDomainHelper.getDataDomainFromExchange(exchange));
                    }
                    TransmissionEvent transmissionEvent = new TransmissionEvent();
                    transmissionEvent.setStartDateTime(Calendar.getInstance().getTime());
                    transmissionEvent.setTimestamp(System.nanoTime());

                    transmissionEvent.setDataDomain(transmission.getDataDomain());
                    if(transmissionEvent.getDataDomain() != null &amp;&amp; !transmissionEvent.getDataDomain().equals(
                            CamelDataDomainHelper.getDataDomainFromExchange(exchange))) {
                        transmissionEvent.getDataDomains().add(
                                CamelDataDomainHelper.getDataDomainFromExchange(exchange));
                    } else if(transmissionEvent.getDataDomain() == null) {
                        transmissionEvent.getDataDomains().add(
                                CamelDataDomainHelper.getDataDomainFromExchange(exchange));
                    }
                    transmissionEvent.setTransmissionId(transmissionId);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\util\EDIFACTTransactionListener.java</td><td>249</td></tr><tr class="a"><td>com\eis\b2bmb\util\EDITransactionListener.java</td><td>236</td></tr><tr class="b"><td colspan='2'><div><pre>        builder.append(&quot;UNZ&quot;+elementDelimiter+&quot;1&quot;+elementDelimiter+interchangeContolNumber+lineTerminator);
        String fileName =  documentId + &quot;|&quot; + interchangeContolNumber +&quot;|&quot;+functionalGroupControlNumber+
                &quot;|&quot;+e.controlNumber;
        String path = mailbox.getDataDomain().replace(&quot;.&quot;, &quot;/&quot;) + &quot;/&quot; + mailbox.getRefName() + &quot;/&quot; +
                fileName;

        String refName = fileName.replaceAll(&quot;\\s&quot;, &quot;&quot;) + &quot;|&quot; +UUID.randomUUID();
        String contentType = &quot;application/octet-stream&quot;;
        BlobMetaData metaData = blobStore.createMetaDataObject();
        metaData.setDataDomain(mailbox.getDataDomain());

        metaData.setPathString(path);
        metaData.setTxId(SecureSession.getTxId());
        Blob blob = null;

        try {
            blob = blobStore
                    .createBlobFromStream(refName, IOUtils.toInputStream(builder.toString()),
                            contentType, metaData);
        } catch (BlobStoreException e1) {
            throw new IllegalStateException(&quot;Could not create blob for transaction:&quot;+fileName);
        }

        Attachment att = new Attachment();
        att.setInlinePayload(false);
        String fileId = blob.getIdAsString();

        att.setPayloadId(fileId);
        att.setFileSize(blob.getSize());

        if (LOG.isInfoEnabled()) {
            LOG.info(&quot;Done, file id: &quot; + fileId);
        }

        att.setContentType(contentType);
        att.setFileName(fileName);
        att.setRefName(path);
        att.setDataDomain(mailbox.getDataDomain());
        att.setId(String.valueOf(UUID.randomUUID()));

        MailboxEntry mailboxEntry = new MailboxEntry();
        mailboxEntry.getAttachments().add(att);
        mailboxEntry.setMailboxId(mailbox.getId());
        mailboxEntry.setDataDomain(mailbox.getDataDomain());
        mailboxEntry.setTransmissionId(transmissionId);
        mailboxEntry.setSubject(fileName);
        mailboxEntry.setToUserId(toAddress);
        mailboxEntry.setFromUserId(fromAddress);
        mailboxEntry.setRefName(refName);
        mailboxEntry.setId(String.valueOf(UUID.randomUUID()));


        mailboxEntry.getMetaData().put(B2bmbCamelConstants.DOCUMENT_TYPE,
                documentId);

        mailboxEntry.getMetaData().put(B2bmbCamelConstants.REFERENCE_DATA,
                referenceData);

        try {
            mailboxEntryDAO.save(mailboxEntry);
        } catch (B2BTransactionFailed b2BTransactionFailed) {
            throw new IllegalStateException(&quot;Could not save mailbox entry for transaction:&quot;+fileName);
        } catch (B2BNotFoundException e1) {
            throw new IllegalStateException(&quot;Could not save mailbox entry for transaction:&quot;+fileName);
        } catch (ValidationException e1) {
            throw new IllegalStateException(&quot;Could not save mailbox entry for transaction:&quot;+fileName);
        }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbB2BProfileDirectoryConsumer.java</td><td>218</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemConsumer.java</td><td>123</td></tr><tr class="b"><td colspan='2'><div><pre>                                    null, fDataDomains);
                            offsetMultiple++;

                            if (fileSystemEntries == null || fileSystemEntries.size() == 0) {
                                queryFileSystemAgain = false;
                            } else {
                                for (final FileSystemEntry fileSystemEntry : fileSystemEntries) {
                                    if (exchanges.size() &lt; maxMessagesPerPoll) {
                                        //make sure we havent created an exchange in this loop or in an earlier poll
                                        if (!getEndpoint().getInProgressRepository().contains(
                                                fileSystemEntry.getId())) {

                                            getEndpoint().getInProgressRepository().add(fileSystemEntry.getId());
                                            //get the blob
                                            Blob fileContents = getEndpoint().getBlobStore().getBlobByStringId(
                                                    fileSystemEntry.getBlobId());
                                            Exchange exchange = getEndpoint().createExchange();
                                            exchange.getIn().setBody(fileContents);
                                            exchange.getIn().setHeader(Exchange.FILE_NAME, fileSystemEntry.getName());
                                            exchange.getIn().setHeader(Exchange.FILE_LENGTH, fileSystemEntry.getSize());
                                            exchange.getIn().setHeader(Exchange.CONTENT_TYPE,
                                                    fileSystemEntry.getContentType());
                                            exchange.setProperty(B2bmbCamelConstants.TRANSMISSION_ID,
                                                    fileSystemEntry.getTransmissionId());
                                            exchange.getIn().setHeader(B2bmbCamelConstants.TRANSMISSION_ID,
                                                    fileSystemEntry.getTransmissionId());
                                            exchange.setProperty(&quot;FileSystemEntryId&quot;, fileSystemEntry.getId());
                                            exchange.addOnCompletion(new SynchronizationAdapter() {
                                                @Override
                                                public void onComplete(Exchange exchange) {
                                                    processRouteCompletion(fileSystemEntry, parentFileSystemEntry,
                                                            getEndpoint(), exchange, true);
                                                }

                                                @Override
                                                public void onFailure(Exchange exchange) {
                                                    processRouteCompletion(fileSystemEntry, parentFileSystemEntry,
                                                            getEndpoint(), exchange, false);
                                                }

                                                @Override
                                                public boolean allowHandover() {
                                                    return false;
                                                }

                                                @Override
                                                public String toString() {
                                                    return &quot;B2bmbFileSystemConsumerOnCompletion&quot;;
                                                }
                                            });
                                            exchanges.add(exchange);
                                        }
                                    }
                                }
                            }
                        }
                        if (exchanges.size() &gt; 0) {
                            Deque&lt;Exchange&gt; q = exchanges;</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPConsumer.java</td><td>119</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPConsumer.java</td><td>114</td></tr><tr class="b"><td colspan='2'><div><pre>                            }

                            long delta = stop.stop();
                            if (this.log.isDebugEnabled()) {
                                this.log.debug(&quot;Took {} to poll: {}&quot;, TimeUtils.printDuration((double) delta), name);
                            }

                            if (limitHit) {
                                this.log.debug(&quot;Limiting maximum messages to poll at {} files as there was more &quot; +
                                        &quot;messages in this poll.&quot;, Integer.valueOf(this.maxMessagesPerPoll));
                            }

                            if (this.endpoint.getSorter() != null) {
                                Collections.sort(files, this.endpoint.getSorter());
                            }

                            LinkedList exchanges = new LinkedList();
                            Iterator q = files.iterator();

                            while (q.hasNext()) {
                                GenericFile total = (GenericFile) q.next();
                                Exchange polledMessages = this.endpoint.createExchange(total);
                                polledMessages.getIn().setHeader(&quot;B2BDirectoryName&quot;, cc.getLocalInDirectoryName());
                                polledMessages.getIn().setHeader(&quot;B2BActiveConnection&quot;, cc.getActive());
                                this.endpoint.configureExchange(polledMessages);
                                this.endpoint.configureMessage(total, polledMessages.getIn());
                                exchanges.add(polledMessages);
                            }

                            if (this.endpoint.getSortBy() != null) {
                                Collections.sort(exchanges, this.endpoint.getSortBy());
                            }

                            if (!this.eagerLimitMaxMessagesPerPoll &amp;&amp; this.maxMessagesPerPoll &gt; 0 &amp;&amp;
                                    files.size() &gt; this.maxMessagesPerPoll) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\endpts\ftp\FTPUserRealm.java</td><td>114</td></tr><tr class="a"><td>com\eis\b2bmb\endpts\ssh\nsoftware\SFTPServerRealm.java</td><td>129</td></tr><tr class="b"><td colspan='2'><div><pre>                throw new AuthenticationException(&quot;Error occured while Authenticating credentials&quot; + e);
            }
            info = new SimpleAuthenticationInfo(userId,
                    password, &quot;SFTPServerRealm&quot;);

        } else if (token instanceof PublicKeyToken) {

            PublicKeyToken upt = (PublicKeyToken) token;
            userId = (String) upt.getPrincipal();

            String[] splitUserId = userId.split(&quot;\\.&quot;);
            if (splitUserId.length == 2) {
                userId = splitUserId[1];
                realm = splitUserId[0];
            }

            String key = (String) upt.getCredentials();

            if (LOG.isDebugEnabled()) {
                LOG.debug(&quot;PublicKeyToken::Logging in with credentials userID:&quot; + userId
                        + &quot;realm:&quot; + realm);

                LOG.debug(&quot;UPT Principles:&quot; + upt.getPrincipal().toString());
            }

            try {


                sftpUser = serverUserDAO.authenticateByKey(userId, key.replaceAll(&quot;\\r\\n|\\n&quot;, &quot;&quot;), realm);

            } catch (B2BException e) {
                throw new AuthenticationException(e);
            } catch (IOException e) {
                throw new AuthenticationException(e);
            }


            SecurityUtils.getSubject().getSession().setAttribute(&quot;sftpUser&quot;, sftpUser);
            info = new SimpleAuthenticationInfo(userId, key
                    , &quot;SFTPServerRealm&quot;);

        } else {
            if (LOG.isWarnEnabled()) {
                LOG.warn(&quot;Could not use token as its not a UserPassword Token?&quot;);
            }
        }

        if (sftpUser == null) {
            throw new IllegalStateException(
                    &quot;unable to find sftp user with id ::&quot; + userId);
        }


        return info;

    }

    /**
     * Retrieves the AuthorizationInfo for the given principals from the underlying data store.  When returning
     * an instance from this method, you might want to consider using an instance of
     * {@link org.apache.shiro.authz.SimpleAuthorizationInfo SimpleAuthorizationInfo}, as it is suitable in most cases.
     *
     * @param principals the primary identifying principals of the AuthorizationInfo that should be retrieved.
     * @return the AuthorizationInfo associated with this principals.
     * @see org.apache.shiro.authz.SimpleAuthorizationInfo
     */
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\util\EDIFACTTransactionListener.java</td><td>317</td></tr><tr class="a"><td>com\eis\b2bmb\util\EDITransactionListener.java</td><td>305</td></tr><tr class="b"><td colspan='2'><div><pre>        transactions.add(mailboxEntry.getId());

    }

    /**
     * Method that captures the start of the loop segment.
     *
     * @param e - EdireaderStartLoopEvent
     */
    public void startLoop(EdireaderStartLoopEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;StartLoop: &quot; + e.name);
        }
    }

    /**
     * Method that captures the end of the loop segment.
     *
     * @param e - EdireaderEndLoopEvent
     */
    public void endLoop(EdireaderEndLoopEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;EndLoop&quot;);
        }
        //functionalGroupBuilder.append(&quot;END&quot;).append(&quot;\n&quot;);
    }

    /**
     * Method that captures when an error occurs.
     *
     * @param e - EdireaderErrorEvent
     */
    public void error(EdireaderErrorEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;ERROR: &quot; + e.errorCode + &quot;:&quot; + e.description);
        }
    }

    /**
     * Method that captures when the schema is resolved.
     *
     * @param e - EdireaderResolveSchemaEvent
     */
    public void resolveSchema(EdireaderResolveSchemaEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;ResolveSchema: &quot; + e.transactionCode);

        }
    }

    /**
     * Method that captures when a segment is read
     *
     * @param e - EdireaderSegmentEvent
     */
    public void segment(EdireaderSegmentEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;Segment: &quot; + e.name + &quot;|L:&quot; + e.loop + &quot;|t:&quot; + e.tag + &quot;|F:&quot; + e.fullSegment);
        }

        if(recordTransaction) {
            String fullSeqment = e.fullSegment;
            builder.append(fullSeqment);
            getReferenceData(e.tag, e.fullSegment);
        }


    }

    /**
     * Method that captures when a warning occurs.
     *
     * @param e - EdireaderWarningEvent
     */
    public void warning(EdireaderWarningEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;WARNING: &quot; + e.warnCode + &quot;: &quot; + e.message);
        }
    }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoCancelSalesOrder.java</td><td>36</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoSalesOrderHold.java</td><td>38</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoSalesOrderUnhold.java</td><td>36</td></tr><tr class="a"><td colspan='2'><div><pre>    @Autowired
    SalesOrderDAO salesOrderDAO;

    /**
     * Accepts a salesOrder json. Following are the required fields on the json
     * - salesOrder.header.salesOrderNumber
     * - salesOrder.refName
     * - dataDomain should exist in the domain and a valid salesOrder should exist for the refName and dataDomain
     *
     * After successfully cancel operarion in Magento, salesOrder.magentoSalesOrderCancelStatus will be
     * updated with a value of 'Y'
     */
    @Override
    Object process(String json, String sessionId, VelocityEngine ve, Exchange exchange,
                   ProducerTemplate template, String endPoint) throws IOException, XPathExpressionException,
            TransformerException, B2BNotAuthorizedException, B2BTransactionFailed, B2BNotAuthenticatedException,
            B2BNotFoundException, ValidationException {
        String dataDomain = CamelDataDomainHelper.getDataDomainFromExchange(exchange);
        checkNotNull(dataDomain, &quot;dataDomain cannot be null&quot;);

        ObjectMapper objectMapper = createObjectMapper();
        SalesOrder salesOrder = objectMapper.readValue(json,
                SalesOrder.class);
        checkNotNull(salesOrder, &quot;Not able to serialise salesOrder&quot;);
        checkNotNull(salesOrder.getHeader(), &quot;SalesOrderHeader is null&quot;);
        String magentoOrderId = null;
        if(salesOrder.getHeader().getOriginalOrderNumber() != null) {
            magentoOrderId = salesOrder.getHeader().getOriginalOrderNumber();
        } else {
            for (Reference referenceIdentification : salesOrder.getReferenceData()) {
                if (referenceIdentification.getType().equals(&quot;originalSalesNumber&quot;)) {
                    magentoOrderId = referenceIdentification.getValue();
                }
            }
        }

        checkNotNull(magentoOrderId,
                &quot;Original Sales Number from Magento is null, but expected to be there for order &quot;
                        + salesOrder.getId());

        SalesOrder so = salesOrderDAO.getByRefName(salesOrder.getRefName(), dataDomain);
        checkNotNull(so, &quot;Sales Order with refNumber &quot; + salesOrder.getRefName()
                + &quot;Not found for datadomain &quot; + dataDomain);

        SalesOrderEntity magentoSalesOrder = getSalesOrderEntity(sessionId,
                magentoOrderId, ve, exchange, template, endPoint);
        boolean magentoOrderAlreadyCancelled = magentoSalesOrder.isOrderCancelled();</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbB2BProfileDirectoryEndpoint.java</td><td>70</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemEndpoint.java</td><td>62</td></tr><tr class="a"><td colspan='2'><div><pre>    }

    @Override
    public boolean isSingleton() {
        return true;
    }

    /**
     * Return the filePath
     * @return file path
     */
    public String getFilePath() {
        return filePath;
    }

    /**
     * Set the filePath
     * @param filePath path for file
     */
    public void setFilePath(String filePath) {
        this.filePath = filePath;
    }

    /**
     * Get the data domain
     * @return domain data domain
     */
    public String getDomain() {
        return domain;
    }

    /**
     * Set the data domain
     * @param domain data domain
     */
    public void setDomain(String domain) {
        this.domain = domain;
    }

    /**
     * Get the regex filter for refname
     * @return regexFilter
     */
    public String getRegexFilter() {
        return regexFilter;
    }

    /**
     * Set the regex filter for refname
     * @param regexFilter regex filter
     */
    public void setRegexFilter(String regexFilter) {
        this.regexFilter = regexFilter;
    }

    /**
     * Get the refname
     * @return refName refName in uri
     */
    public String getRefName() {
        return refName;
    }

    /**
     * Set the refname
     * @param refName refName in uri
     */
    public void setRefName(String refName) {
        this.refName = refName;
    }

    /**
     * Set the contentType
     * @return contentType
     */
    public String getContentType() {
        return contentType;
    }

    /**
     * Get the contentType
     * @param contentType contentType in uri
     */
    public void setContentType(String contentType) {
        this.contentType = contentType;
    }

    /**
     * Get the name of directory to move files to if route is successful
     * Default is .processed
     * @return directory name
     */
    public String getSuccessDirectory() {
        return successDirectory;
    }

    /**
     * Get the name of directory to move files to if route is successful
     * @param successDirectory directory name
     */
    public void setSuccessDirectory(String successDirectory) {
        this.successDirectory = successDirectory;
    }

    /**
     * Get the name of directory to move files to if route is unsuccessful
     * Default is .errored
     * @return directory name
     */
    public String getErrorDirectory() {
        return errorDirectory;
    }

    /**
     * Set the name of directory to move files to if route is unsuccessful
     * @param errorDirectory directory name
     */
    public void setErrorDirectory(String errorDirectory) {
        this.errorDirectory = errorDirectory;
    }

    /**
     * An indicator Y or N that indicates if the poll will be from several directories passed in
     * as a Camel Header : B2BDirectoryList.  If this is set to Y and there is a B2BDirectoryList
     * passed in, the file path on the uri will not be used and it will loop over the list of
     * values in the B2BDirectoryList to find files.
     *
     * @return - indicator Y or N that indicates if we will be polling a list of directories
     */
    public String getSearchDirectoryList() {
        return searchDirectoryList;
    }

    /**
     * Sets an indicator Y or N that indicates if the poll will be from several directories passed in
     * as a Camel Header : B2BDirectoryList.  If this is set to Y and there is a B2BDirectoryList
     * passed in, the file path on the uri will not be used and it will loop over the list of
     * values in the B2BDirectoryList to find files.
     *
     * @param searchDirectoryList - indicator Y or N that indicates if we will be polling a list of directories
     */
    public void setSearchDirectoryList(String searchDirectoryList) {
        this.searchDirectoryList = searchDirectoryList;
    }

    /**
     * Get the fileSystemEntryDAO
     * @return fileSystemEntryDAO
     */
    public FileSystemEntryDAO getFileSystemEntryDAO() {
        return fileSystemEntryDAO;
    }

    /**
     * Set the fileSystemEntryDAO
     * @param fileSystemEntryDAO fileSystemEntryDAO
     */
    public void setFileSystemEntryDAO(FileSystemEntryDAO fileSystemEntryDAO) {
        this.fileSystemEntryDAO = fileSystemEntryDAO;
    }

    /**
     * Set the ediProfileDAO.
     *
     * @return ediProfileDAO
     */
    public EDIProfileDAO getEdiProfileDAO() {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbEDITransactionSplitterEndpoint.java</td><td>68</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxEndpoint.java</td><td>79</td></tr><tr class="a"><td colspan='2'><div><pre>    }

    /**
     * to create singleton  object of endpoint
     *
     * @return boolean
     */

    public boolean isSingleton() {
        return true;
    }

    /**
     * Get to user
     * @return to user
     */
    public String getTo() {
        return to;
    }

    /**
     * Set to user
     * @param to user
     */
    public void setTo(String to) {
        this.to = to;
    }

    /**
     * Get from user
     * @return from user
     */
    public String getFrom() {
        return from;
    }

    /**
     * Set from user
     * @param from user
     */
    public void setFrom(String from) {
        this.from = from;
    }

    /**
     * Get domain
     * @return domain
     */
    public String getDomain() {
        return domain;
    }

    /**
     * Set domain
     * @param domain dataDomain
     */
    public void setDomain(String domain) {
        this.domain = domain;
    }

    /**
     * Get mailbox name
     * @return mailbox name
     */
    public String getMailboxName() {
        return mailboxName;
    }

    /**
     * Set mailbox name
     * @param mailboxName mailbox refName
     */
    public void setMailboxName(String mailboxName) {
        this.mailboxName = mailboxName;
    }

    /**
     * Get subject
     * @return subject
     */
    public String getSubject() {
        return subject;
    }

    /**
     * Set subject
     * @param subject subject for message
     */
    public void setSubject(String subject) {
        this.subject = subject;
    }

    /**
     * Get error mailbox name
     * @return error mailbox name
     */
    public String getErrorMailboxName() {
        return errorMailboxName;
    }

    /**
     * Set error mailbox name
     * @param errorMailboxName error mailbox name
     */
    public void setErrorMailboxName(String errorMailboxName) {
        this.errorMailboxName = errorMailboxName;
    }

    /**
     * Get processed mailbox name
     * @return processed mailbox name
     */
    public String getProcessedMailboxName() {
        return processedMailboxName;
    }

    /**
     * Set processed mailbox name
     * @param processedMailboxName processed mailbox name
     */
    public void setProcessedMailboxName(String processedMailboxName) {
        this.processedMailboxName = processedMailboxName;
    }

    /**
     * Get parameter that indicates if mail should be sorted by email addresses and
     * sequence number.
     * @return 'true' if we want to sort
     */
    public String getSortMail() {
        return sortMail;
    }

    /**
     * Sets parameter that indicates if mail should be sorted by email addresses and
     * sequence number.
     * @param sortMail -  'true' if we want to sort
     */
    public void setSortMail(String sortMail) {
        this.sortMail = sortMail;
    }

    /**
     * Gets the parameter that indicates if we just want the mailbox entry id as the
     * body of the message.
     *
     * @return 'true' if we want just the id in the body
     */
    public String getIdAsBody() {
        return idAsBody;
    }

    /**
     * Gets the parameter that indicates if we just want the mailbox entry id as the
     * body of the message.
     *
     * @param idAsBody 'true' if we want just the id in the body
     */
    public void setIdAsBody(String idAsBody) {
        this.idAsBody = idAsBody;
    }

    /**
     * Get mailboxEntryDAO
     * @return mailboxEntryDAO
     */
    public MailboxEntryDAO getMailboxEntryDAO() {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptConsumer.java</td><td>275</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptProducer.java</td><td>248</td></tr><tr class="a"><td colspan='2'><div><pre>                String msg = &quot;There was a problem executing script:&quot; + script.getRefName() + &quot; from route:&quot; +
                        exchange.getFromRouteId() +
                        &quot; problem was:&quot; + se.getMessage();
                if (LOG.isErrorEnabled()) {
                    LOG.error(msg);
                }
                script.setBlacklisted(true);
                script.setBlacklistReason(msg);
                exceptionOccurred = true;
                throw se;
            } finally {
                if (exceptionOccurred) {
                    try {
                        scriptDAO.save(script);

                    } catch (B2BTransactionFailed e) {
                        if (LOG.isErrorEnabled()) {
                            LOG.error(&quot;There was a problem saving the script:&quot; + script.getRefName() + &quot; exception:&quot; +
                                    e.getMessage());
                        }
                    } catch (B2BNotFoundException e) {
                        if (LOG.isErrorEnabled()) {
                            LOG.error(&quot;There was a problem saving the script:&quot; + script.getRefName() + &quot; exception:&quot; +
                                    e.getMessage());
                        }
                    } catch (ValidationException e) {
                        if (LOG.isErrorEnabled()) {
                            LOG.error(&quot;There was a problem saving the script:&quot; + script.getRefName() + &quot; exception:&quot; +
                                    e.getMessage());
                        }
                    }
                }
            }
        }
        else {
            throw new B2BNotFoundException(&quot;Script &quot; + script + &quot;was not found.&quot;);
        }
    }

    @Override
    public B2bmbScriptEndpoint getEndpoint() {

        return (B2bmbScriptEndpoint) super.getEndpoint();
    }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptConsumer.java</td><td>179</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptProducer.java</td><td>187</td></tr><tr class="a"><td colspan='2'><div><pre>                            SecureSession.setUser(dbu);

                            TenancyManagerService tm = getEndpoint().getTenancyManagerService();

                            SecureSession.setSecurityManager(tm);
                            SecureSession.setAction(&quot;RUN SCRIPT&quot;);


                        }
                        else {


                            if (LOG.isWarnEnabled()) {
                                LOG.warn(&quot;&gt;&gt; Running script with no associated userProfile, service calls will fail&quot;);

                            }


                        }

                        JSRunner runner = new JSRunner();
                        returnScript = runner.runJS(script, blackListedPackages);

                    } finally {


                        if (useRunAs) {
                            Subject s = SecurityUtils.getSubject();
                            s.releaseRunAs();
                            s.logout();
                            SecureSession.clearAll();
                        }

                        if (threadState != null) {
                            threadState.restore();
                        }

                    }


                    //set outputs
                    if (returnScript.getType() != null &amp;&amp; returnScript.getType().getOutputs() != null
                            &amp;&amp; returnScript.getType().getOutputs().getAttributes() != null) {

                        for (DynamicAttribute attribute : returnScript.getType().getOutputs().getAttributes().values
                                ()) {

                            String attributeName = attribute.getRefName();

                            if (attributeName != null) {

                                if (&quot;body&quot;.equals(attributeName)) {
                                    exchange.getIn().setBody(attribute.getValue());</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPProducer.java</td><td>96</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPProducer.java</td><td>97</td></tr><tr class="a"><td colspan='2'><div><pre>        B2bmbFTPEndpoint sftpEndpoint = (B2bmbFTPEndpoint) endpoint;
        String dataDomain = sftpEndpoint.getDataDomain();
        dataDomains.add(dataDomain);
        CommunicationConfiguration cc = null;
        try {
            List&lt;CommunicationConfiguration&gt; communicationConfigurations =
                    sftpEndpoint.getCommunicationConfigurationDAO().getList(
                            dynamicSearchRequest, 0, 10, null, dataDomains);

            if(communicationConfigurations == null || communicationConfigurations.size() == 0) {
                throw new IllegalStateException(&quot;No Communication Configuration found for directory:&quot;+
                  b2bmbDirectoryName+ &quot; can not send file.&quot;);
            } else if(communicationConfigurations.size() &gt; 1) {
                throw new IllegalStateException(&quot;Multiple Communication Configurations found for directory:&quot;+
                        b2bmbDirectoryName+ &quot; can not send file.&quot;);
            } else {
                cc = communicationConfigurations.get(0);
            }

        } catch (B2BTransactionFailed e) {
            if(LOG.isErrorEnabled()) {
                LOG.error(&quot;Could not query for Communication Configurations&quot;, e);
            }

            throw new IllegalStateException(&quot;Could not query for Communication Configurations&quot;, e);
        }

        if(cc != null) {
            if(&quot;Y&quot;.equals(cc.getActive())) {
                try {
                    storeFile(exchange, b2bmbDirectoryName, dataDomain);
                    //CHECKSTYLE:OFF
                } catch (Exception e) {
                    throw new IllegalStateException(&quot;Could not store file in directory:&quot; + b2bmbDirectoryName
                            + &quot; in dataDomain:&quot; + dataDomain, e);
                }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbMapForceServerProducer.java</td><td>563</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\EDIFactValidator.java</td><td>185</td></tr><tr class="a"><td colspan='2'><div><pre>        }
    }

    private void createMailboxEntryForRejectedDocument(Mailbox mailbox, Exchange exchange,
                                                       Attachment doc997, Attachment docMain)
            throws NoSuchHeaderException, BlobStoreException, ValidationException, B2BTransactionFailed,
            B2BNotFoundException {

        MailboxEntry mailboxEntry = new MailboxEntry();
        mailboxEntry.getAttachments().add(doc997);
        mailboxEntry.getAttachments().add(docMain);
        mailboxEntry.setMailboxId(mailbox.getId());
        mailboxEntry.setDataDomain(mailbox.getDataDomain());
        mailboxEntry.setTransmissionId(exchange.getProperty(B2bmbCamelConstants.TRANSMISSION_ID, String.class));
        mailboxEntry.setSequenceNumber(
                exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER,
                        BigInteger.class));


        //these could be on from the endpoint or from headers...endpoint are default.  seems good
        mailboxEntry.setToUserId(ExchangeHelper.getMandatoryHeader(exchange, B2bmbCamelConstants.TO, String.class));
        mailboxEntry.setFromUserId( ExchangeHelper.getMandatoryHeader(exchange, B2bmbCamelConstants.FROM,
                String.class));
        String subject = exchange.getIn().getHeader(B2bmbCamelConstants.SUBJECT, String.class);

        if (subject == null) {
            //fall back to filename
            subject = &quot;Document has been rejected. Check 997 and original document.&quot;;
        }
        mailboxEntry.setSubject(subject);
        mailboxEntry.setRefName(UUID.randomUUID()+&quot;-Rejected&quot;);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\endpts\ftp\FTPUserRealm.java</td><td>49</td></tr><tr class="b"><td>com\eis\b2bmb\endpts\ssh\nsoftware\SFTPServerRealm.java</td><td>63</td></tr><tr class="a"><td colspan='2'><div><pre>    }

    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(
            AuthenticationToken token) throws AuthenticationException {

        AuthenticationInfo info = null;
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;&gt;&gt;&gt; Attempting authentication of user:&quot;
                    + token.toString());
        }

        if (token == null) {
            if (LOG.isErrorEnabled()) {
                LOG.error(&quot;Null token received throwing illegal argument exception&quot;);
            }
            throw new IllegalArgumentException(&quot;token can not be null&quot;);
        }

        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;Getting AuthenticationInfo&quot;);
        }

        String userId = null;
        String password = null;
        String realm = null;

        SFTPServerUser sftpUser = null;

        if (token instanceof UsernamePasswordToken) {

            UsernamePasswordToken upt = (UsernamePasswordToken) token;
            userId = upt.getUsername();

            String[] splitUserId = userId.split(&quot;\\.&quot;);
            if (splitUserId.length == 2) {
                userId = splitUserId[1];
                realm = splitUserId[0];
            }

            password = new String(upt.getPassword());

            if (LOG.isDebugEnabled()) {
                LOG.debug(&quot;UserNamePasswordToken::Logging in with credentials userID:&quot; + userId
                        + &quot; password:&quot; + password + &quot;realm:&quot; + realm);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>85</td></tr><tr class="b"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>126</td></tr><tr class="a"><td colspan='2'><div><pre>    public RouteDef resume(String refName, String domainName) throws B2BNotAuthenticatedException,
            B2BTransactionFailed, B2BNotAuthorizedException, B2BNotFoundException, ValidationException {
        // first check that the routeDef making the call is authenticated.
        Subject subject = SecurityUtils.getSubject();

        if (routeExecuterHelper == null) {
            throw new IllegalArgumentException(&quot;routeExecuterHelper is not injected properly into the service&quot;);
        }
        if (refName == null) {
            throw new IllegalArgumentException(&quot;refName can not be null&quot;);
        }
        if (domainName == null) {
            domainName = SecureSession.getUser().getDataDomain();
        }
        if (!subject.isAuthenticated()) {
            throw new B2BNotAuthenticatedException(&quot;Subject is not authenticated, &quot; +
                    &quot;while this call requires an authenticated subject, please authenticate before making this call&quot;,
                    B2BSecurityException.REASON_CODE.NOT_AUTHENTICATED);
        }

        RouteDef routeDef = routeDefDAO.getByRefName(refName, domainName);

        if (routeDef != null) {
            if (!subject.isPermitted(&quot;RouteDef:Execute:&quot; + domainName)) {
                throw new B2BNotAuthorizedException(&quot;The Subject:&quot; + subject.getPrincipal() + &quot; does not have the &quot; +
                        &quot;privilege: RouteDef:Execute:&quot; + domainName + &quot; refusing request&quot;,
                        B2BSecurityException.REASON_CODE.NOT_AUTHORIZED);
            }
        } else {
            throw new B2BNotFoundException(&quot;The route with the refName:&quot; + refName + &quot; in data domain: &quot; + domainName
                    + &quot; was not found&quot;);
        }

        routeDef = routeExecuterHelper.resume(routeDef);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>85</td></tr><tr class="b"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>126</td></tr><tr class="a"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>168</td></tr><tr class="b"><td colspan='2'><div><pre>    public RouteDef resume(String refName, String domainName) throws B2BNotAuthenticatedException,
            B2BTransactionFailed, B2BNotAuthorizedException, B2BNotFoundException, ValidationException {
        // first check that the routeDef making the call is authenticated.
        Subject subject = SecurityUtils.getSubject();

        if (routeExecuterHelper == null) {
            throw new IllegalArgumentException(&quot;routeExecuterHelper is not injected properly into the service&quot;);
        }
        if (refName == null) {
            throw new IllegalArgumentException(&quot;refName can not be null&quot;);
        }
        if (domainName == null) {
            domainName = SecureSession.getUser().getDataDomain();
        }
        if (!subject.isAuthenticated()) {
            throw new B2BNotAuthenticatedException(&quot;Subject is not authenticated, &quot; +
                    &quot;while this call requires an authenticated subject, please authenticate before making this call&quot;,
                    B2BSecurityException.REASON_CODE.NOT_AUTHENTICATED);
        }

        RouteDef routeDef = routeDefDAO.getByRefName(refName, domainName);

        if (routeDef != null) {
            if (!subject.isPermitted(&quot;RouteDef:Execute:&quot; + domainName)) {
                throw new B2BNotAuthorizedException(&quot;The Subject:&quot; + subject.getPrincipal() + &quot; does not have the &quot; +
                        &quot;privilege: RouteDef:Execute:&quot; + domainName + &quot; refusing request&quot;,
                        B2BSecurityException.REASON_CODE.NOT_AUTHORIZED);
            }
        } else {
            throw new B2BNotFoundException(&quot;The route with the refName:&quot; + refName + &quot; in data domain: &quot; + domainName
                    + &quot; was not found&quot;);
        }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxProducer.java</td><td>241</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\processor\GetMailByIdProcessor.java</td><td>112</td></tr><tr class="b"><td colspan='2'><div><pre>        if (exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER) != null) {
            mailboxEntry.setSequenceNumber(
                    exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER,
                            BigInteger.class));
        }

        if (exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class) != null) {
            mailboxEntry.getMetaData().put(B2bmbCamelConstants.DOCUMENT_TYPE,
                    exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class));
        }

        if (exchange.getIn().getHeader(B2bmbCamelConstants.REFERENCE_DATA, Map.class) != null) {
            Map&lt;String, Object&gt; referenceData = (Map&lt;String, Object&gt;) exchange.getIn().getHeader(
                    B2bmbCamelConstants.REFERENCE_DATA, Map.class);
            mailboxEntry.getMetaData().putAll(referenceData);
        }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbEDITransactionSplitterComponent.java</td><td>56</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxComponent.java</td><td>72</td></tr><tr class="b"><td colspan='2'><div><pre>    @Override
    protected void validateURI(String uri, String path, Map parameters)
            throws ResolveEndpointFailedException {
        super.validateURI(uri, path, parameters);
        if (!path.contains(&quot;/&quot;)) {
            throw new ResolveEndpointFailedException(&quot;Data domain and mailbox refname must be in the uri&quot;);
        }
        String dataDomain = path.substring(0, path.indexOf('/'));
        String mailboxName = path.substring(path.indexOf('/') + 1);


        try {
            Mailbox mailbox = mailboxDAO.getByRefName(mailboxName, dataDomain);
            if (mailbox == null) {
                throw new ResolveEndpointFailedException(&quot;Unable to resolve mailbox with data domain &quot; +
                        dataDomain + &quot; and mailbox name &quot; + mailboxName);
            }
        } catch (B2BTransactionFailed b2BTransactionFailed) {
            throw new ResolveEndpointFailedException(&quot;Unable to resolve mailbox with data domain &quot; +
                    dataDomain + &quot; and mailbox name &quot; + mailboxName);
        }
    }

    /**
     * @param uri        endpoint uri
     * @param remaining  string of uri ,after //
     * @param parameters map of parameters
     * @return endpoint created endpoint
     * @throws Exception exception thrown by camel runtime system
     */
    protected Endpoint createEndpoint(String uri, String remaining, Map&lt;String, Object&gt; parameters) throws Exception {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemProducer.java</td><td>40</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPProducer.java</td><td>303</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPProducer.java</td><td>304</td></tr><tr class="a"><td colspan='2'><div><pre>                    + &quot; Path: &quot; + getEndpoint().getFilePath());
        }
        //default content type
        String contentType = &quot;application/octet-stream&quot;;
        if (exchange.getIn().getHeader(Exchange.CONTENT_TYPE, String.class) != null) {
            contentType = exchange.getIn().getHeader(Exchange.CONTENT_TYPE, String.class);
        }

        String fileName = exchange.getIn().getHeader(Exchange.FILE_NAME, String.class);
        if (fileName == null)
        {
            fileName = exchange.getIn().getHeader(&quot;DOWNLOADED_FILE&quot;, String.class);

        }

        if (fileName == null)
        {
            throw new IllegalStateException(&quot;File Name could not be resolved, need either:&quot; + Exchange.FILE_NAME +
                    &quot; or &quot; + &quot;DOWNLOADED_FILE in header&quot;);
        }


        InputStream in = exchange.getIn().getBody(InputStream.class);

        if ( in != null)
        {
            getEndpoint().getFileSystemEntryDAO().createFileFromStream(exchange.getExchangeId(),
                    fileName,</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\endpts\ssh\nsoftware\SFTPServerHelper.java</td><td>1599</td></tr><tr class="b"><td>com\eis\b2bmb\endpts\ssh\nsoftware\SFTPServerHelper.java</td><td>1679</td></tr><tr class="a"><td colspan='2'><div><pre>                    String handle = createNewHandle(path, metaData);
                                /*blobService.createBlobHandle(e.path,metaData);*/
                    OutputStream out = getOutputStreamForHandle(handle);
                    //blobService.getStreamForHandle (handle);


                    OpenFile openFile = new OpenFile();
                    openFile.connectionId = event.connectionId;
                    openFile.path = path;
                    openFile.setUser(event.user);
                    openFile.setFlag(event.flags);
                    openFile.setOutputStream(out);
                    event.handle = handle;
                    openFile.setHandle(event.handle);

                    LOG.debug(&quot;Setting handle for the open file :: handle &gt;&gt; &quot;
                            + openFile.getHandle() + &quot; :: openFile&quot; +
                            &quot;.getKey() &gt;&gt; &quot; + openFile.getKey());

                    openFiles.put(openFile.getKey(), openFile);
                    handle2Path.put(event.connectionId + &quot;:&quot; + openFile.getHandle(), path);

                    statusCode = SFTPServer.SSH_FX_OK; // SSH_FX_FILE_ALREADY_EXISTS

                }
                else {
                    if (LOG.isErrorEnabled()) {
                        LOG.error(&quot;Unsupported operation&quot;);
                    }

                    statusCode = SFTPServer.SSH_FX_OP_UNSUPPORTED; // SSH_FX_OP_UNSUPPORTED
                }


            }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemComponent.java</td><td>23</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbValidatorComponent.java</td><td>29</td></tr><tr class="a"><td colspan='2'><div><pre>    private static final Logger LOG = LoggerFactory.getLogger(B2bmbFileSystemComponent.class);

    /**
     * fileSystemEntryDAO - injected by camel
     */
    @Autowired
    protected FileSystemEntryDAO fileSystemEntryDAO;

    /**
     * blobStore - injected by camel
     */
    @Autowired
    protected BlobStore blobStore;

    @Override
    protected void validateURI(String uri, String path, Map parameters)
            throws ResolveEndpointFailedException {
        super.validateURI(uri, path, parameters);
        if (!path.contains(&quot;/&quot;)) {
            throw new ResolveEndpointFailedException(&quot;Data domain and file path must be in the uri&quot;);
        }
        String dataDomain = path.substring(0, path.indexOf('/'));
        String filePath = path.substring(path.indexOf('/') + 1);

        try {
            FileSystemEntry fileSystemEntry = fileSystemEntryDAO.getByRefName(filePath, dataDomain);
            if (fileSystemEntry == null) {
                throw new ResolveEndpointFailedException(&quot;Unable to resolve file path with data domain &quot; +
                        dataDomain + &quot; and file path &quot; + filePath);
            }
        } catch (B2BTransactionFailed b2BTransactionFailed) {
            throw new ResolveEndpointFailedException(&quot;Unable to resolve file path with data domain &quot; +
                    dataDomain + &quot; and file path &quot; + filePath);
        }
    }</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxProducer.java</td><td>236</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\util\MailboxEntryHelper.java</td><td>130</td></tr><tr class="a"><td colspan='2'><div><pre>        mailboxEntry.setMailboxId(mailbox.getId());
        mailboxEntry.setDataDomain(mailbox.getDataDomain());
        mailboxEntry.setTransmissionId(exchange.getIn().getHeader(B2bmbCamelConstants.TRANSMISSION_ID,
                String.class));

        if (exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER) != null) {
            mailboxEntry.setSequenceNumber(
                    exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER,
                            BigInteger.class));
        }

        if (exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class) != null) {
            mailboxEntry.getMetaData().put(B2bmbCamelConstants.DOCUMENT_TYPE,
                    exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class));
        }

        if (exchange.getIn().getHeader(B2bmbCamelConstants.REFERENCE_DATA, Map.class) != null) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptConsumer.java</td><td>121</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptProducer.java</td><td>132</td></tr><tr class="a"><td colspan='2'><div><pre>                                    }
                                }
                            }
                        }
                    }

                    boolean useRunAs = false;

                    if (script.getRunAsId() != null &amp;&amp;
                            userProfileDAO != null) {
                        useRunAs = true;
                    }

                    //Subject s = SecurityUtils.getSubject();
                    ThreadState threadState = null;
                    Script returnScript = null;

                    try {
                        if (useRunAs) {
                            PrincipalCollection pc = new SimplePrincipalCollection(script.getRunAsId(),
                                    &quot;MultiTenantRealm&quot;);

                            Subject s = new Subject.Builder().principals(pc).sessionCreationEnabled(true)
                                    .authenticated(true).buildSubject();
                            threadState = new SubjectThreadState(s);
                            threadState.bind();

                            if (LOG.isInfoEnabled()) {
                                LOG.info(&quot;Running script under with RunAs with Id:&quot; + script.getRunAsId());
                            }

                            UserProfile dbu = userProfileDAO.getByUserId(script.getRunAsId());
                            if (dbu == null) {
                                throw new B2BNotFoundException(&quot;the user with userId:&quot; + script.getRunAsId()</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\util\EDIFACTTransactionListener.java</td><td>404</td></tr><tr class="b"><td>com\eis\b2bmb\util\EDITransactionListener.java</td><td>381</td></tr><tr class="a"><td colspan='2'><div><pre>    }

    private void getReferenceData(String tag, String segment) {

        if (availableDocumentDAO != null) {

            try {
                if (availableDocument == null) {
                    availableDocument = availableDocumentDAO.getAvailableDocument(documentId, version);
                }
                if (availableDocument != null) {
                    LinkedHashMap&lt;String, SegmentData&gt; segmentDatas = availableDocument.getSegmentDatas();
                    if (segmentDatas.size() &gt; 0) {
                        Collection&lt;SegmentData&gt; datas = segmentDatas.values();
                        for (SegmentData segmentData : datas) {
                            if (segmentData.getSegmentTag().equals(tag)) {
                                List&lt;String&gt; refData = null;
                                segment = segment.replace(&quot;\r&quot;, &quot;&quot;).replace(&quot;\n&quot;, &quot;&quot;);
                                String[] elementComponents = segment.split(&quot;[&quot; + elementDelimiter + &quot;]&quot;);
                                String elementComponent = elementComponents[segmentData.getElementPosition()];</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbEDITransactionSplitterEndpoint.java</td><td>308</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxEndpoint.java</td><td>372</td></tr><tr class="a"><td colspan='2'><div><pre>    }

    /**
     * Get the repository for mailbox entries in process of being sent
     * @return inProgressRepository
     */
    public IdempotentRepository&lt;String&gt; getInProgressRepository() {
        return inProgressRepository;
    }

    /**
     * Set the repository for mailbox entries in process of being sent
     * @param inProgressRepository repository
     */
    public void setInProgressRepository(IdempotentRepository&lt;String&gt; inProgressRepository) {
        this.inProgressRepository = inProgressRepository;
    }

    @Override
    protected void doStart() throws Exception {
        ServiceHelper.startServices(inProgressRepository);
        super.doStart();
    }

    @Override
    protected void doStop() throws Exception {
        super.doStop();
        ServiceHelper.stopServices(inProgressRepository);
    }

    @Override
    public String toString() {
        return &quot;B2bmbMailboxEndpoint{&quot; +
                &quot;to='&quot; + to + '\'' +
                &quot;, from='&quot; + from + '\'' +
                &quot;, subject='&quot; + subject + '\'' +
                &quot;, domain='&quot; + domain + '\'' +
                &quot;, mailboxName='&quot; + mailboxName + '\'' +
                &quot;, errorMailboxName='&quot; + errorMailboxName + '\'' +
                &quot;, processedMailboxName='&quot; + processedMailboxName + '\'' +
                &quot;, sortMail='&quot; + sortMail + '\'' +
                &quot;, idAsBody='&quot; + idAsBody + '\'' +
                '}';
    }
}</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPEndpoint.java</td><td>93</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPEndpoint.java</td><td>88</td></tr><tr class="a"><td colspan='2'><div><pre>        return new B2bmbFTPConsumer(this, processor, createRemoteFileOperations());
    }


    /**
     * to create singleton  object of endpoint
     *
     * @return boolean
     */

    public boolean isSingleton() {
        return true;
    }


    @Override
    protected void doStart() throws Exception {
        ServiceHelper.startServices(inProgressRepository);
        super.doStart();
    }

    @Override
    protected void doStop() throws Exception {
        super.doStop();
        ServiceHelper.stopServices(inProgressRepository);
    }



    /**
     * @return String domain
     */
    public String getDataDomain() {
        return dataDomain;
    }

    /**
     * Set the domain
     *
     * @param dataDomainx name
     */
    public void setDataDomain(String dataDomainx) {
        this.dataDomain = dataDomainx;
    }

    /**
     * Returns a string which identifies if the Communication Configurations should be filtered
     * by a specific vendor.
     *
     * @return - String identifying the vendor to filter by
     */
    public String getVendor() {
        return vendor;
    }

    /**
     * Sets a string which identifies if the Communication Configurations should be filtered
     * by a specific vendor.
     *
     * @param vendor - string identify the vendor to filter by
     */
    public void setVendor(String vendor) {
        this.vendor = vendor;
    }


    /**
     * Returns the String identifying which directory location from the Communication Configuration
     * should be used - inDirectoryName or outDirectoryName.
     *
     * @return - the String identifying which directory
     */
    public String getB2bDirectoryLocation() {
        return b2bDirectoryLocation;
    }

    /**
     * Sets the String identifying which directory location from the Communication Configuration
     * should be used - inDirectoryName or outDirectoryName.
     *
     * @param b2bDirectoryLocation - String identifying which directory location should be used
     */
    public void setB2bDirectoryLocation(String b2bDirectoryLocation) {
        this.b2bDirectoryLocation = b2bDirectoryLocation;
    }

    /**
     * Get the Communication Configuration DAO
     * @return the DAO
     */
    public CommunicationConfigurationDAO getCommunicationConfigurationDAO() {
        return communicationConfigurationDAO;
    }

    /**
     * Set the DAO implementation to use
     *
     * @param communicationConfigurationDAO the dao
     */
    public void setCommunicationConfigurationDAO(CommunicationConfigurationDAO communicationConfigurationDAO) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptConsumer.java</td><td>93</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbScriptProducer.java</td><td>65</td></tr><tr class="a"><td colspan='2'><div><pre>            boolean exceptionOccurred = false;
            try {
                if (!script.isBlacklisted()) {
                    //I guess should do this?
                    List&lt;String&gt; blackListedPackages = new ArrayList&lt;String&gt;();
                    Correlation correlation = correlationDAO.getByRefName(&quot;BlackListScriptPackages&quot;,
                            Constants.B2BMAILBOX_APP_DATADOMAIN);
                    if (correlation != null) {
                        blackListedPackages = (List&lt;String&gt;) correlation.getValue();
                    }
                    //set inputs
                    if (script.getType() != null &amp;&amp; script.getType().getInputs() != null
                            &amp;&amp; script.getType().getInputs().getAttributes() != null) {
                        for (DynamicAttribute attribute : script.getType().getInputs().getAttributes().values()) {
                            String attributeName = attribute.getRefName();</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbMapForceServerProducer.java</td><td>77</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbMapForceServerProducer.java</td><td>626</td></tr><tr class="a"><td colspan='2'><div><pre>            String to = getEndpoint().getTo() != null ? getEndpoint().getTo()
                    : ExchangeHelper.getMandatoryHeader(exchange, B2bmbCamelConstants.TO, String.class);
            String from = getEndpoint().getFrom() != null ? getEndpoint().getFrom()
                    : ExchangeHelper.getMandatoryHeader(exchange, B2bmbCamelConstants.FROM, String.class);

            String subject = getEndpoint().getSubject() != null ? getEndpoint().getSubject()
                    : ExchangeHelper.getMandatoryHeader(exchange, B2bmbCamelConstants.SUBJECT, String.class);
            String fileType = exchange.getIn().getHeader(B2bmbCamelConstants.FILE_TYPE, String.class);
            String dataDomain = CamelDataDomainHelper.getDataDomainFromExchange(exchange);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\util\MailboxEntryHelper.java</td><td>110</td></tr><tr class="b"><td>com\eis\b2bmb\util\EDIFACTTransactionListener.java</td><td>272</td></tr><tr class="a"><td>com\eis\b2bmb\util\EDITransactionListener.java</td><td>259</td></tr><tr class="b"><td colspan='2'><div><pre>                .createBlobFromStream(blobRefName, inputStream, contentType, metaData);


        att.setInlinePayload(false);
        String fileId = blob.getIdAsString();

        att.setPayloadId(fileId);
        att.setFileSize(blob.getSize());

        if (LOG.isInfoEnabled()) {
            LOG.info(&quot;Done, file id: &quot; + fileId);
        }
        att.setContentType(contentType);
        att.setFileName(fileName);
        att.setRefName(path);
        att.setDataDomain(mailbox.getDataDomain());
        att.setId(String.valueOf(UUID.randomUUID()));

        MailboxEntry mailboxEntry = new MailboxEntry();
        mailboxEntry.getAttachments().add(att);
        mailboxEntry.setMailboxId(mailbox.getId());
        mailboxEntry.setDataDomain(mailbox.getDataDomain());
        mailboxEntry.setTransmissionId(exchange.getIn().getHeader(B2bmbCamelConstants.TRANSMISSION_ID,</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\B2BMBErrorHandler.java</td><td>14</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\processor\B2BMBExceptionHandler.java</td><td>14</td></tr><tr class="b"><td colspan='2'><div><pre>public class B2BMBErrorHandler  implements Processor {

    @Autowired
    NotifyAndCreateTaskHelper taskHelper;

    @Override
    public void process(Exchange exchange) throws Exception {
        // the caused by exception is stored in a property on the exchange
        Throwable caused = exchange.getProperty(Exchange.EXCEPTION_CAUGHT, Throwable.class);
        String subject = &quot;B2B Exception:&quot;+caused.getMessage();
        StringBuilder builder = new StringBuilder();
        builder.append(&quot;\nException Trace\n:&quot;);
        for (StackTraceElement ste : exchange.getException().getStackTrace()) {
            builder.append(ste.toString() + &quot;\n&quot;);
        }
        String body = builder.toString();
        taskHelper.notifyAndCreateTask(&quot;Error:&quot;+String.valueOf(UUID.randomUUID()),  subject,
                body, subject, CamelDataDomainHelper.getDataDomainFromExchange(exchange),
                &quot;System Error&quot;, &quot;exceptions&quot;, &quot;Tony Costanzo&quot;);
    }

}</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPProducer.java</td><td>38</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPProducer.java</td><td>38</td></tr><tr class="b"><td colspan='2'><div><pre>    public B2bmbFTPProducer(B2bmbFTPEndpoint endpoint, FtpOperations operations) {

        super(endpoint, operations);
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;creating  B2bmbRemoteFileProducer  object  &quot;);
        }
    }

    @Override
    public void process(Exchange exchange) throws Exception {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;Inside process method of B2bRemoteFileProducer &quot;);
        }
        if (exchange == null) {
            throw new IllegalArgumentException(&quot;The exchange cannot be null&quot;);
        }
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;Inside process method of B2bRemoteFileProducer &quot;);
        }

        String target = createFileName(exchange);
        if(target != null) {
            processExchange(exchange, target);
        }

    }

    @Override
    public String createFileName(Exchange exchange) {
        String answer;

        // overrule takes precedence
        Object value;
        String b2bmbDirectoryName = exchange.getIn().getHeader(&quot;B2BDirectoryName&quot;, String.class);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbB2BProfileDirectoryEndpoint.java</td><td>354</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemEndpoint.java</td><td>237</td></tr><tr class="b"><td colspan='2'><div><pre>    }

    /**
     * Get the repository for mailbox entries in process of being sent
     * @return inProgressRepository
     */
    public IdempotentRepository&lt;String&gt; getInProgressRepository() {
        return inProgressRepository;
    }

    /**
     * Set the repository for mailbox entries in process of being sent
     * @param inProgressRepository repository
     */
    public void setInProgressRepository(IdempotentRepository&lt;String&gt; inProgressRepository) {
        this.inProgressRepository = inProgressRepository;
    }

    @Override
    protected void doStart() throws Exception {
        ServiceHelper.startServices(inProgressRepository);
        super.doStart();
    }

    @Override
    protected void doStop() throws Exception {
        super.doStop();
        ServiceHelper.stopServices(inProgressRepository);
    }

    @Override
    public String toString() {
        return &quot;B2bmbFileSystemEndpoint{&quot; +
                &quot;regexFilter='&quot; + regexFilter + '\'' +
                &quot;, contentType='&quot; + contentType + '\'' +
                &quot;, refName='&quot; + refName + '\'' +
                &quot;, successDirectory='&quot; + successDirectory + '\'' +
                &quot;, errorDirectory='&quot; + errorDirectory + '\'' +
                &quot;, filePath='&quot; + filePath + '\'' +
                &quot;, domain='&quot; + domain + '\'' +
                '}';
    }
}</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>41</td></tr><tr class="a"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>85</td></tr><tr class="b"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>126</td></tr><tr class="a"><td>com\eis\b2bmb\api\v1\services\impl\RouteExecuterServiceImpl.java</td><td>168</td></tr><tr class="b"><td colspan='2'><div><pre>    public RouteDef pause(String refName, String domainName) throws B2BNotAuthenticatedException,
            B2BTransactionFailed, B2BNotAuthorizedException, B2BNotFoundException, ValidationException {
        // first check that the routeDef making the call is authenticated.
        Subject subject = SecurityUtils.getSubject();

        if (routeExecuterHelper == null) {
            throw new IllegalArgumentException(&quot;routeExecuterHelper is not injected properly into the service&quot;);
        }
        if (refName == null) {
            throw new IllegalArgumentException(&quot;refName can not be null&quot;);
        }
        if (domainName == null) {
            domainName = SecureSession.getUser().getDataDomain();
        }
        if (!subject.isAuthenticated()) {
            throw new B2BNotAuthenticatedException(&quot;Subject is not authenticated, &quot; +
                    &quot;while this call requires an authenticated subject, please authenticate before making this call&quot;,
                    B2BSecurityException.REASON_CODE.NOT_AUTHENTICATED);
        }

        RouteDef routeDef = routeDefDAO.getByRefName(refName, domainName);

        if (routeDef != null) {
            if (!subject.isPermitted(&quot;RouteDef:Execute:&quot; + routeDef.getDataDomain())) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbB2BProfileDirectoryConsumer.java</td><td>309</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemConsumer.java</td><td>200</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPProducer.java</td><td>264</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPProducer.java</td><td>265</td></tr><tr class="b"><td colspan='2'><div><pre>            List&lt;FileSystemEntry&gt; fileSystemEntries = null;

            DynamicSearchRequest dynamicSearchRequest = new DynamicSearchRequest();
            DynamicAttribute parentAttribute = new DynamicAttribute();
            parentAttribute.setType(DynamicAttributeType.String);
            parentAttribute.setValue(parentFileSystemEntry.getId());
            parentAttribute.setRefName(&quot;parentFileEntryId&quot;);
            dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;parentFileEntryId&quot;, parentAttribute);

            DynamicAttribute directoryOnlyAttribute = new DynamicAttribute();
            directoryOnlyAttribute.setType(DynamicAttributeType.String);
            directoryOnlyAttribute.setValue(FileSystemEntryType.Directory.value());
            directoryOnlyAttribute.setRefName(&quot;type&quot;);
            dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;type&quot;, directoryOnlyAttribute);

            DynamicAttribute directoryNameAttribute = new DynamicAttribute();
            directoryNameAttribute.setType(DynamicAttributeType.String);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbMapForceServerProducer.java</td><td>658</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\processor\EDIFactValidator.java</td><td>272</td></tr><tr class="b"><td colspan='2'><div><pre>                .createBlobFromStream(refName,inputStream, &quot;text/plain&quot;, metaData);

        att.setInlinePayload(false);
        String fileId = blob.getIdAsString();

        att.setPayloadId(fileId);
        att.setFileSize(blob.getSize());

        if (LOG.isInfoEnabled()) {
            LOG.info(&quot;Done, file id: &quot; + fileId);
        }
        att.setContentType(&quot;text/plain&quot;);
        att.setFileSize(blob.getSize());
        att.setFileName(newFileName);
        att.setRefName(path);
        att.setDataDomain(mailbox.getDataDomain());
        att.setId(String.valueOf(UUID.randomUUID()));
        return att;
    }

    private EDIProfile getEDIProfile(String fromAddress, String toAddress, Exchange exchange)</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoCancelSalesOrder.java</td><td>154</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoSalesOrderHold.java</td><td>150</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoSalesOrderUnhold.java</td><td>149</td></tr><tr class="a"><td colspan='2'><div><pre>        String salesOrderId;

        MagentoResponse(boolean callFailed, String salesOrderId) {
            this.callFailed = callFailed;
            this.salesOrderId = salesOrderId;
        }

        public boolean isCallFailed() {
            return callFailed;
        }

        public void setCallFailed(boolean callFailed) {
            this.callFailed = callFailed;
        }

        public double getFailureCount() {
            return failureCount;
        }

        public void setFailureCount(double failureCount) {
            this.failureCount = failureCount;
        }

        public String getType() {
            return type;
        }

        public void setType(String type) {
            this.type = type;
        }

        public String getSalesOrderId() {
            return salesOrderId;
        }

        public void setSalesOrderId(String salesOrderId) {
            this.salesOrderId = salesOrderId;
        }
    }
}</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoCancelSalesOrder.java</td><td>117</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoSalesOrderUnhold.java</td><td>113</td></tr><tr class="a"><td colspan='2'><div><pre>                failureCount = ((Integer) so.getDynAttributes().get(&quot;numMagentoCancelAttempts&quot;));
                failureCount++;
            }
            LOG.error(&quot;Magento call failed - Response from Magento &quot; + callResponse);
            magentoResponse.setFailureCount(failureCount);
            return objectMapper.writeValueAsString(magentoResponse);
        }
    }

    @Override
    Object handleLoginErrors(String json, Exchange exchange) throws IOException, B2BTransactionFailed {

        String dataDomain = CamelDataDomainHelper.getDataDomainFromExchange(exchange);

        ObjectMapper objectMapper = createObjectMapper();
        SalesOrder salesOrder = objectMapper.readValue(json,
                SalesOrder.class);
        SalesOrder so = salesOrderDAO.getByRefName(salesOrder.getRefName(), dataDomain);
        MagentoResponse magentoResponse = new MagentoResponse(true, so.getId());
        Integer failureCount = 0;
        if(so.getDynAttributes().get(&quot;numMagentoCancelAttempts&quot;) == null) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPConsumer.java</td><td>63</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPProducer.java</td><td>86</td></tr><tr class="a"><td colspan='2'><div><pre>        dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;communicationProtocol&quot;, parentAttribute);

        if(getEndpoint().getVendor() != null &amp;&amp; !&quot;&quot;.equals(getEndpoint().getVendor())) {
            DynamicAttribute connectionAttribute = new DynamicAttribute();
            connectionAttribute.setType(DynamicAttributeType.String);
            connectionAttribute.setValue(getEndpoint().getVendor());
            connectionAttribute.setRefName(&quot;vendor&quot;);
            dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;vendor&quot;, connectionAttribute);
        }

        List&lt;String&gt; dataDomains = new ArrayList&lt;String&gt;();
        B2bmbSFTPEndpoint sftpEndpoint = (B2bmbSFTPEndpoint) endpoint;
        String dataDomain = sftpEndpoint.getDataDomain();
        dataDomains.add(dataDomain);</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbFTPConsumer.java</td><td>61</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbSFTPConsumer.java</td><td>61</td></tr><tr class="a"><td colspan='2'><div><pre>        parentAttribute.setValue(&quot;FTP&quot;);
        parentAttribute.setRefName(&quot;communicationProtocol&quot;);
        dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;communicationProtocol&quot;, parentAttribute);

        if(getEndpoint().getVendor() != null &amp;&amp; !&quot;&quot;.equals(getEndpoint().getVendor())) {
            DynamicAttribute connectionAttribute = new DynamicAttribute();
            connectionAttribute.setType(DynamicAttributeType.String);
            connectionAttribute.setValue(getEndpoint().getVendor());
            connectionAttribute.setRefName(&quot;vendor&quot;);
            dynamicSearchRequest.getSearchFields().getAttributes().put(&quot;vendor&quot;, connectionAttribute);
        }

        List&lt;String&gt; dataDomains = new ArrayList&lt;String&gt;();</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxConsumer.java</td><td>281</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\GetMailByIdProcessor.java</td><td>108</td></tr><tr class="a"><td colspan='2'><div><pre>        try {
            Mailbox mailbox = null;

            if(exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER) != null){
                mailboxEntry.setSequenceNumber(
                        exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER,
                                BigInteger.class));
            }

            if(exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class) != null) {
                mailboxEntry.getMetaData().put(B2bmbCamelConstants.DOCUMENT_TYPE,
                        exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class));
            }

            if(exchange.getIn().getHeader(B2bmbCamelConstants.FILE_TYPE, String.class) != null) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbEDITransactionSplitterEndpoint.java</td><td>292</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemEndpoint.java</td><td>221</td></tr><tr class="a"><td colspan='2'><div><pre>    }

    /**
     * Get blobStore
     * @return blobStore
     */
    public BlobStore getBlobStore() {
        return blobStore;
    }

    /**
     * Set blobStore
     * @param blobStore blobStore
     */
    public void setBlobStore(BlobStore blobStore) {
        this.blobStore = blobStore;
    }

    /**
     * Get the repository for mailbox entries in process of being sent
     * @return inProgressRepository
     */
    public IdempotentRepository&lt;String&gt; getInProgressRepository() {
        return inProgressRepository;
    }

    /**
     * Set the repository for mailbox entries in process of being sent
     * @param inProgressRepository repository
     */
    public void setInProgressRepository(IdempotentRepository&lt;String&gt; inProgressRepository) {
        this.inProgressRepository = inProgressRepository;
    }

    @Override
    protected void doStart() throws Exception {
        ServiceHelper.startServices(inProgressRepository);
        super.doStart();
    }

    @Override
    protected void doStop() throws Exception {
        super.doStop();
        ServiceHelper.stopServices(inProgressRepository);
    }

    @Override
    public String toString() {
        return &quot;B2bmbMailboxEndpoint{&quot; +</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\interceptor\CamelTransmissionInterceptor.java</td><td>118</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\notifier\CamelConsumerTransmissionGenerator.java</td><td>121</td></tr><tr class="a"><td colspan='2'><div><pre>                        for (String headerKey : exchange.getIn().getHeaders().keySet()) {
                            if(!headerKey.equals(B2bmbCamelConstants.REFERENCE_DATA)) {
                                DynamicAttribute headerAttribute = new DynamicAttribute();
                                headerAttribute.setType(DynamicAttributeType.Text);
                                headerAttribute.setLabel(headerKey + &quot;:&quot;);
                                headerAttribute.setRequired(false);
                                headerAttribute.setRefName(headerKey);
                                headerAttribute.setValue(String.valueOf(exchange.getIn().getHeader(headerKey)));
                                das.getAttributes().put(headerKey, headerAttribute);
                            }
                        }
                        if (exchange.getException() != null) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbB2BProfileDirectoryConsumer.java</td><td>379</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbFileSystemConsumer.java</td><td>270</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxConsumer.java</td><td>348</td></tr><tr class="b"><td colspan='2'><div><pre>            getEndpoint().getInProgressRepository().remove(fileSystemEntry.getId());
        }
    }
    @Override
    public int processBatch(Queue&lt;Object&gt; exchanges) {

        final int total = exchanges.size();

        for (int index = 0; index &lt; total &amp;&amp; isBatchAllowed(); index++) {
            // only loop if we are started (allowed to run)
            Exchange exchange = (Exchange) exchanges.poll();
            // add current index and total as properties
            exchange.setProperty(Exchange.BATCH_INDEX, index);
            exchange.setProperty(Exchange.BATCH_SIZE, total);
            exchange.setProperty(Exchange.BATCH_COMPLETE, index == total - 1);

            // update pending number of exchanges
            pendingExchanges = total - index - 1;
            String mailboxEntryId = exchange.getProperty(&quot;FileSystemEntryId&quot;).toString();</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxConsumer.java</td><td>284</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\component\B2bmbMailboxProducer.java</td><td>241</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\GetMailByIdProcessor.java</td><td>112</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\util\MailboxEntryHelper.java</td><td>135</td></tr><tr class="b"><td colspan='2'><div><pre>            if(exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER) != null){
                mailboxEntry.setSequenceNumber(
                        exchange.getIn().getHeader(B2bmbCamelConstants.MAIL_SEQUENCE_NUMBER,
                                BigInteger.class));
            }

            if(exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class) != null) {
                mailboxEntry.getMetaData().put(B2bmbCamelConstants.DOCUMENT_TYPE,
                        exchange.getIn().getHeader(B2bmbCamelConstants.DOCUMENT_TYPE, String.class));
            }

            if(exchange.getIn().getHeader(B2bmbCamelConstants.FILE_TYPE, String.class) != null) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="a"><th>File</th><th>Line</th></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoCancelSalesOrder.java</td><td>120</td></tr><tr class="a"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoSalesOrderHold.java</td><td>117</td></tr><tr class="b"><td>com\eis\b2bmb\camel\custom\processor\magento\MagentoSalesOrderUnhold.java</td><td>116</td></tr><tr class="a"><td colspan='2'><div><pre>            LOG.error(&quot;Magento call failed - Response from Magento &quot; + callResponse);
            magentoResponse.setFailureCount(failureCount);
            return objectMapper.writeValueAsString(magentoResponse);
        }
    }

    @Override
    Object handleLoginErrors(String json, Exchange exchange) throws IOException, B2BTransactionFailed {

        String dataDomain = CamelDataDomainHelper.getDataDomainFromExchange(exchange);

        ObjectMapper objectMapper = createObjectMapper();
        SalesOrder salesOrder = objectMapper.readValue(json,
                SalesOrder.class);
        SalesOrder so = salesOrderDAO.getByRefName(salesOrder.getRefName(), dataDomain);
        MagentoResponse magentoResponse = new MagentoResponse(true, so.getId());
        Integer failureCount = 0;
        if(so.getDynAttributes().get(&quot;numMagentoCancelAttempts&quot;) == null) {</pre></div></td></tr></table><table align="center" border="0" class="bodyTable"><tr class="b"><th>File</th><th>Line</th></tr><tr class="a"><td>com\eis\b2bmb\util\EDIFACTTransactionListener.java</td><td>146</td></tr><tr class="b"><td>com\eis\b2bmb\util\EDITransactionListener.java</td><td>136</td></tr><tr class="a"><td colspan='2'><div><pre>    }

    /**
     * Method that captures the end of the interchange segment.
     *
     * @param e - EdireaderEndInterchangeEvent
     */
    public void endInterchange(EdireaderEndInterchangeEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;EndInterchange: &quot; + &quot; Tag:&quot; + e.tag + &quot; Control Number:&quot; + e.controlNumber + &quot; FullSegment:&quot;
                    + e.fullSegment);
        }

        endInterchange = e.fullSegment;
    }

    /**
     * Method that captures the start of the functional group segment.
     *
     * @param e - EdireaderStartFunctionalGroupEvent
     */
    public void startFunctionalGroup(EdireaderStartFunctionalGroupEvent e) {
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;StartFunctionalGroup: &quot; + &quot; Tag:&quot; + e.tag + &quot; Control Number:&quot; + e.controlNumber
                    + &quot; FullSegment:&quot; + e.fullSegment);
        }

        startFunctionalGroup = e.fullSegment;
        functionalGroupControlNumber = e.controlNumber;</pre></div></td></tr></table></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">Copyright &#169;  All Rights Reserved.      
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
